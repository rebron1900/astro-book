---
import Activitypub from './Activitypub.astro';
const { postID } = Astro.props;
---

<div id="activitypub" data-postid={postID}>
    <div>
        <h3 id="join-comments">è”é‚¦äº’åŠ¨</h3>
        <div></div>
    </div>
    <Activitypub />
</div>

<div id="comments">
    <div>
        <h3 id="join-comments">åŠ å…¥è¯„è®º</h3>
    </div>
    <div class="at-comments"></div>
</div>

<script>
    import 'artalk/dist/Artalk.css';
    import Artalk from 'artalk';
    import cocoMessage from '../utils/coco-message';

    const commentinfo = { type: 'artalk', name: "1900'Blog", server: 'https://artalk.1900.live', el: '.at-comments' };

    const isExternalLink = (url: string) => {
        // è§£æä¼ å…¥çš„ URL
        const parsedUrl = new URL(url);

        // ä» config.blogURL ä¸­æå–ä¸»æœºå
        const blogHostname = location.hostname;

        // æ£€æŸ¥ä¼ å…¥çš„ URL çš„ä¸»æœºåæ˜¯å¦ä¸ blogHostname åŒ¹é…æˆ–å…¶å­åŸŸå
        if (parsedUrl.hostname === blogHostname || parsedUrl.hostname === 'www' + blogHostname) {
            return true;
        }

        return false;
    };

    document.addEventListener('astro:page-load', () => {
        if (!document.querySelector(commentinfo.el)) return;
        const artalk = Artalk.init({
            el: commentinfo.el, // ç»‘å®šå…ƒç´ çš„ Selector
            server: commentinfo.server, // åç«¯åœ°å€
            site: commentinfo.name, // ä½ çš„ç«™ç‚¹å
            pageKey: document.location.pathname
        });

        artalk.on('comment-inserted', function () {
            cocoMessage.insertCSS();
            cocoMessage.success('æ„Ÿè°¢ä½ å‘è¡¨çš„æƒ³æ³• ğŸ’–');
        });

        artalk.on('list-loaded', () => {
            document.querySelectorAll('.atk-comment a').forEach((i) => {
                i.href = isExternalLink(i.href) ? i.href : `/golink?target=${btoa(encodeURIComponent(i.href))}`;
            });
        });
    });
</script>

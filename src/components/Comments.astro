---
import Activitypub from './Activitypub.astro';
const { postID } = Astro.props;
---

<div id="activitypub" data-postid={postID}>
    <div>
        <h3 class="card-title">æ¥è‡ªè”é‚¦å®‡å®™çš„å›åº”</h3>
    </div>

    <div class="social-interactions">
        <ol class="discussion-avatar-list"></ol>
        <div class="social-note">
            åœ¨ Mastodon å®ä¾‹ä¸Šæœç´¢æ­¤ URL æ¥å›å¤ (<a href="https://www.eallion.com/fediverse/" target="_blank">è”é‚¦å®‡å®™åŠMastodonç®€ä»‹ by eallion</a>)<br />
            <code>https://social.1900.live/@1900/statuses/</code>
        </div>
    </div>
</div>

<div id="comments">
    <div>
        <h3 id="join-comments" class="card-title">åŠ å…¥è¯„è®º</h3>
    </div>
    <div class="at-comments"></div>
</div>

<script>
    import 'artalk/dist/Artalk.css';
    import Artalk from 'artalk';
    import cocoMessage from '../utils/coco-message';
    import loadInteractions from '../utils/acitivitypub';

    const commentinfo = { type: 'artalk', name: "1900'Blog", server: 'https://artalk.1900.live', el: '.at-comments' };

    const isExternalLink = (url: string): boolean => {
        try {
            const parsedUrl = new URL(url); // å¯èƒ½æŠ›å¼‚å¸¸
            const blogHostname = location.hostname; // å½“å‰ç«™ç‚¹çš„ä¸»æœºå

            // åˆ¤æ–­æ˜¯å¦ä¸ºç«™å†…é“¾æ¥ï¼ˆå« www å­åŸŸï¼‰
            return parsedUrl.hostname === blogHostname || parsedUrl.hostname === `www.${blogHostname}`;
        } catch {
            // è§£æå¤±è´¥ â†’ ä¸æ˜¯åˆæ³• URLï¼Œç›´æ¥è¿”å› false
            return false;
        }
    };
    document.addEventListener('astro:page-load', () => {
        if (!document.querySelector(commentinfo.el)) return;
        const artalk = Artalk.init({
            el: commentinfo.el, // ç»‘å®šå…ƒç´ çš„ Selector
            server: commentinfo.server, // åç«¯åœ°å€
            site: commentinfo.name, // ä½ çš„ç«™ç‚¹å
            pageKey: document.location.pathname
        });

        loadInteractions();

        artalk.on('comment-inserted', function () {
            cocoMessage.insertCSS();
            cocoMessage.success('æ„Ÿè°¢ä½ å‘è¡¨çš„æƒ³æ³• ğŸ’–');
        });

        artalk.on('list-loaded', () => {
            document.querySelectorAll('.atk-comment a').forEach((i) => {
                i.href = isExternalLink(i.href) ? i.href : `/golink?target=${btoa(encodeURIComponent(i.href))}`;
            });
        });
    });
</script>

---
// OGCard.astro
// 用法：<OGCard href="https://neodb.social/movie/xxx" />
import { parse } from 'node-html-parser';

export interface Props {
    href: string;
}

const { href } = Astro.props;

/* 1. 白名单正则：4 种链接 */
const ALLOWED_REGEX = /^(https?:\/\/)?(www\.)?(neodb\.social\/(tv\/season|movie|book)\/[\w\-]+|github\.com\/[^\/]+\/[^\/]+|bilibili\.com\/video\/[\w\-]+\/?)$/i;

if (!ALLOWED_REGEX.test(href)) return null;

/* 2. 根据域名决定如何取元数据 */
let og: {
    title?: string;
    description?: string;
    image?: string;
    siteName?: string;
} = {};

try {
    const url = new URL(href);
    const html = await fetch(href, {
        headers: { 'User-Agent': 'Astro-OGCard/1.0' }
    }).then((r) => r.text());

    /* 2.1 通用解析器：从 <meta property="og:*"> 拿数据 */
    function getMeta(prop: string): string {
        const root = parse(html);

        // 1) 先找 og:xxx
        const og = root.querySelector(`meta[property="og:${prop}"]`);
        if (og) return og.getAttribute('content') ?? '';

        // 2) 如果是 description，再兜底 <meta name="description">
        if (prop === 'description') {
            const fallback = root.querySelector('meta[name="description"]');
            return fallback?.getAttribute('content') ?? '';
        }

        return '';
    }

    /* 2.3 其余站点（NeoDB / GitHub）直接走通用解析 */
    og.title = getMeta('title') || getMeta('site_name') || url.hostname;
    og.description = getMeta('description');
    og.image = href.includes('bilibili.com') ? 'https://images.weserv.nl/?url=' + getMeta('image').replace('@100w_100h', '@500w_500h') : getMeta('image');
    og.siteName = getMeta('site_name') || url.hostname;
} catch {
    return null;
}

if (!og.title) return null;
---

<a href={href} target="_blank" rel="noopener noreferrer" class="og-card">
    {
        og.image && (
            <div class="og-image">
                <img src={og.image} alt={og.title} loading="lazy" />
            </div>
        )
    }

    <div class="og-body">
        <p class="og-title">{og.title}</p>
        {og.description && <p class="og-desc">{og.description}</p>}
        <p class="og-site">{og.siteName}</p>
    </div>
</a>

<style></style>

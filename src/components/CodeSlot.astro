---
import { Code } from 'astro:components';
import { transformerNotationDiff, transformerNotationHighlight } from '@shikijs/transformers';
import { parseHTML } from 'linkedom'; // 1. 引入 linkedom

const html = await Astro.slots.render('default');

// 2. 用 linkedom 解析
const { document } = parseHTML(html);

// 3. 取第一个 <code> 标签
const codeEl = document.querySelector('code');
const code = codeEl ? codeEl.textContent : '';
const langRaw = codeEl?.className?.replace(/^language-/, '') || '';
const lang = langRaw || 'plaintext';
---

<Code
    wrap={true}
    code={code}
    lang={lang}
    themes={{ dark: 'vitesse-dark', light: 'vitesse-light' }}
    defaultColor={false}
    transformers={[transformerNotationDiff(), transformerNotationHighlight()]}
/>

<script>
    import { initCopyButton } from '../utils/code';
    initCopyButton();
    document.addEventListener('astro:after-swap', () => {
        initCopyButton();
    });
</script>

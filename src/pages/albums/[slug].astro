---
import { extractAlbumsFromPosts, getSolarTermGroups } from '../../utils/albums';
import { settings } from '../../data/ghost-store.js';

import BaseLayout from '../../layouts/BaseLayout.astro';
import Head from '../../components/Head.astro';
import Comments from '../../components/Comments.astro';
import Relitu from '../../components/Relitu.jsx';
import Header from '../../components/Header.astro';
import Menu from '../../components/Menu.astro';
import RemotePicture from '../../components/RemotePicture.astro';
import { Masonry } from 'astro-masonry';

export function getStaticPaths() {
    const albums = extractAlbumsFromPosts();
    return albums.map((album) => ({
        params: { slug: album.slug },
        props: { album, slug: album.slug }
    }));
}

const { album } = Astro.props;

const page = {
    title: `${album.name} - 相册`,
    slug: `albums/${album.slug}`,
    html: '',
    excerpt: `${album.name} 相册，包含 ${album.images.length} 张图片`,
    created_at: album.createdAt.toISOString(),
    updated_at: album.updatedAt.toISOString(),
    feature_image: album.coverImages[0]?.url || null,
    tag: album.tag,
    authors: []
};

const yearlySolarTermGroups = getSolarTermGroups(album);
---

<BaseLayout post={page}>
    <Head slot="head" post={page} site={settings} title={`${album.name} | ${settings?.title} - 相册`} />

    <Header slot="header" title={`${album.name} 相册`} />
    <Menu slot="menu" />
    <article slot="content" class="markdown book-article">
        <h1 class="book-title">{album.name}</h1>
        <blockquote>{page.tag.description}</blockquote>
        <hr />

        {
            yearlySolarTermGroups.length > 0 ? (
                <div class="solar-term-groups">
                    {yearlySolarTermGroups.map((yearGroup) => (
                        <div class="year-group">
                            <h2 class="year-title">{yearGroup.year}年</h2>
                            <hr />
                            <div class="year-terms">
                                <Masonry
                                    breakpointCols={{
                                        default: 6,
                                        1024: 4,
                                        768: 2,
                                        500: 1
                                    }}
                                >
                                    {yearGroup.terms.map((group) => (
                                        <div class="solar-term-group">
                                            {group.hasContent == true ? (
                                                group.images
                                                    .map((image, index) => {
                                                        const post = group.posts.find(
                                                            (p) => p.html && (p.html.includes(image.url) || p.feature_image === image.url)
                                                        );
                                                        const date = post ? new Date(post.created_at) : new Date();
                                                        return {
                                                            image,
                                                            post,
                                                            date,
                                                            index
                                                        };
                                                    })
                                                    .sort((a, b) => b.date.getTime() - a.date.getTime())
                                                    .map(({ image, date, index }) => (
                                                        <div class="photo-card">
                                                            <div class="photo-image-container">
                                                                <RemotePicture
                                                                    src={image.url}
                                                                    alt={image.alt || `${group.term} 图片 ${index + 1}`}
                                                                    class="photo-image"
                                                                />
                                                            </div>
                                                            <div class="photo-date">
                                                                {String(date.getMonth() + 1).padStart(2, '0')}月 / {group.term}
                                                            </div>
                                                        </div>
                                                    ))
                                            ) : (
                                                <div class="photo-card">
                                                    <div class="photo-image-container no-image" data-info="缺失" />
                                                    <div class="photo-date">00 / {group.term}</div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </Masonry>
                            </div>
                        </div>
                    ))}
                </div>
            ) : (
                <div>
                    <Masonry
                        breakpointCols={{
                            default: 4,
                            1024: 3,
                            768: 2,
                            500: 1
                        }}
                    >
                        {album.images.map((image, index) => (
                            <div>
                                <RemotePicture src={image.url} alt={image.alt || `${album.name} 图片 ${index + 1}`} />
                            </div>
                        ))}
                    </Masonry>
                </div>
            )
        }
    </article>

    <Comments slot="comments" />

    <Relitu slot="relitu" />
</BaseLayout>

<style>
    .solar-term-groups .photo-card {
        border-radius: 8px;
        overflow: hidden;
        transition: transform 0.2s ease;
    }
    .photo-image-container.no-image {
        background-color: var(--gray-200);

        &::after {
            content: attr(data-info);
            position: absolute;
            display: flex;
            width: 100%;
            text-align: center;
            height: 100%;
            align-items: center;
            justify-content: center;
            color: var(--gray-500);
        }
    }
    .solar-term-groups .photo-card:hover {
        transform: translateY(-2px);
    }

    .solar-term-groups .photo-image-container {
        position: relative;
        width: 100%;
        height: 0;
        padding-bottom: 150%; /* 4:3 宽高比 */
        overflow: hidden;
    }

    .solar-term-groups .photo-image-container :global(img) {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .solar-term-groups .photo-date {
        display: block;
        padding: 0.5rem;
        text-align: center;
        font-size: 0.875rem;
        color: #666;
    }

    .year-group {
        margin-bottom: 3rem;
    }

    .solar-term-empty {
        text-align: center;
        padding: 2rem 1rem;
        background: #f9f9f9;
        border-radius: 8px;
        margin: 1rem 0;
    }

    .solar-term-empty .empty-icon {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        opacity: 0.5;
    }

    .solar-term-empty .empty-text {
        font-size: 1rem;
        font-weight: 500;
        color: #666;
        margin-bottom: 0.25rem;
    }

    .solar-term-empty .empty-subtext {
        font-size: 0.8rem;
        color: #999;
    }

    @media (max-width: 768px) {
        .solar-term-groups .photo-image-container {
            padding-bottom: 150%; /* 3:2 宽高比在移动设备上 */
        }

        .solar-term-groups .photo-date {
            font-size: 0.75rem;
            padding: 0.375rem;
        }
    }
</style>
